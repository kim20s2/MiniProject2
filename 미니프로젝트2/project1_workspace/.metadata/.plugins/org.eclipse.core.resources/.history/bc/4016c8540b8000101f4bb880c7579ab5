// =============================
// aiot_task.c
// =============================
#include "cmsis_os.h"
#include <stdio.h>
#include "esp.h"

extern osMutexId_t ESP_MutexHandle;

int esp_is_wifi_ready(void);

// Aiot_Task.c
// Aiot_Task.c
void Aiot_Task(void *argument)
{
    AiotClient_Init();

    for(;;) {
        int wifi_ok = esp_is_wifi_ready();   // 바깥에서 잠그지 않음
        int tcp_ok  = esp_get_status();      // 바깥에서 잠그지 않음

        if (!wifi_ok) {
            vTaskDelay(pdMS_TO_TICKS(2000));
            continue;
        }

        // ★ Link0 기준으로 미연결이면 접속 시도
        if (tcp_ok != 0) {
            printf("server connecting ...\r\n");
            if (osMutexAcquire(ESP_MutexHandle, osWaitForever)==osOK) {
                int rc = esp_client_conn();   // 여기만 잠금 유지
                osMutexRelease(ESP_MutexHandle);
                printf("[AIOT] conn rc=%d\r\n", rc);
            }
        }
        else {
        	esp_client_conn();
        }

        vTaskDelay(pdMS_TO_TICKS(10000));
    }
}


