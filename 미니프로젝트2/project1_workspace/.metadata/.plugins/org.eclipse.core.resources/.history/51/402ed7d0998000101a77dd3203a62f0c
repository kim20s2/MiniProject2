/*
 * mfrc522.h
 *
 *  Created on: Aug 24, 2025
 *      Author: kim20
 */

#ifndef INC_MFRC522_H_
#define INC_MFRC522_H_

#include "stm32f4xx_hal.h"
#include <stdint.h>

// ===== 사용자 환경 설정 =====
// SPI 핸들 (CubeMX에서 생성한 것을 extern)
extern SPI_HandleTypeDef hspi3;

// RC522 연결 핀 (프로젝트 핀맵에 맞게 수정)
#define MFRC522_CS_GPIO_Port   GPIOA
#define MFRC522_CS_Pin         GPIO_PIN_4
#define MFRC522_RST_GPIO_Port  GPIOB
#define MFRC522_RST_Pin        GPIO_PIN_0

// SPI 속도: 초기 레지스터 설정 시에는 2~4MHz 권장, 이후 10MHz까지 가능
// CubeMX에서 SPI3 Prescaler 설정으로 조절

// ===== RC522 레지스터 =====
#define CommandReg         0x01
#define ComIEnReg          0x02
#define DivIEnReg          0x03
#define ComIrqReg          0x04
#define DivIrqReg          0x05
#define ErrorReg           0x06
#define Status1Reg         0x07
#define Status2Reg         0x08
#define FIFODataReg        0x09
#define FIFOLevelReg       0x0A
#define ControlReg         0x0C
#define BitFramingReg      0x0D
#define ModeReg            0x11
#define TxControlReg       0x14
#define TxASKReg           0x15
#define CRCResultRegH      0x21
#define CRCResultRegL      0x22
#define TModeReg           0x2A
#define TPrescalerReg      0x2B
#define TReloadRegH        0x2C
#define TReloadRegL        0x2D
#define VersionReg         0x37

// ===== 명령어 =====
#define PCD_Idle           0x00
#define PCD_Mem            0x01
#define PCD_GenerateRandomID 0x02
#define PCD_CalcCRC        0x03
#define PCD_Transmit       0x04
#define PCD_NoCmdChange    0x07
#define PCD_Receive        0x08
#define PCD_Transceive     0x0C
#define PCD_MFAuthent      0x0E
#define PCD_SoftReset      0x0F

// ===== PICC (카드) 명령 =====
#define PICC_REQIDL        0x26
#define PICC_REQALL        0x52
#define PICC_ANTICOLL      0x93
#define PICC_SELECTTAG     0x93
#define PICC_HALT          0x50

// ===== 상태 코드 =====
#define MI_OK              0
#define MI_NOTAGERR        1
#define MI_ERR             2

// ===== API =====
void     MFRC522_Init(void);
uint8_t  MFRC522_Request(uint8_t reqMode, uint8_t *ATQA /*2B*/);
uint8_t  MFRC522_Anticoll(uint8_t *uid /*최대 10B*/);
uint8_t  MFRC522_SelectTag(uint8_t *uid);
void     MFRC522_AntennaOn(void);
void     MFRC522_AntennaOff(void);

// 디버그용
uint8_t  MFRC522_ReadReg(uint8_t reg);
void     MFRC522_WriteReg(uint8_t reg, uint8_t val);

#endif // __MFRC522_H__

