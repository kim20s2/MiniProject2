// =============================
// aiot_task.c
// =============================
#include "cmsis_os2.h"
#include <stdio.h>
#include "esp.h"

extern osMutexId_t ESP_MutexHandle;

int esp_is_wifi_ready(void);
void AiotClient_Init(void);   // 기존 초기화 함수 extern 선언

// Aiot_Task.c
void Aiot_Task(void *argument)
{
    AiotClient_Init();

    for(;;) {
        int wifi_ok = esp_is_wifi_ready();
        int tcp_ok  = esp_get_status();

        if (!wifi_ok) {
            vTaskDelay(pdMS_TO_TICKS(2000));
            continue;
        }

        if (tcp_ok != 0) {  // 연결 안 되었을 때만 접속
            printf("server connecting ...\r\n");
            if (osMutexAcquire(ESP_MutexHandle, osWaitForever)==osOK) {
                int rc = esp_client_conn();
                osMutexRelease(ESP_MutexHandle);
                printf("[AIOT] conn rc=%d\r\n", rc);
            }
        }

        vTaskDelay(pdMS_TO_TICKS(10000));
    }
}


