#include "i2c.h"

/* ====== 핀 설정 안내 ======
 * 기본: I2C1 SCL=PB8, SDA=PB9 (AF4)  [NUCLEO 기본 핀맵]
 * 만약 PB6/PB7을 쓰면 아래 매크로를 6/7로 바꾸고 GPIO_Init도 맞춰주세요.
 */
#define I2C1_SCL_PORT   GPIOB
#define I2C1_SDA_PORT   GPIOB
#define I2C1_SCL_PIN    GPIO_PIN_8   // PB8 -> SCL
#define I2C1_SDA_PIN    GPIO_PIN_9   // PB9 -> SDA
#define I2C1_AF         GPIO_AF4_I2C1

I2C_HandleTypeDef hi2c1;

void MX_I2C1_Init(void)
{
    hi2c1.Instance             = I2C1;
    hi2c1.Init.ClockSpeed      = 100000;                // 100kHz
    hi2c1.Init.DutyCycle       = I2C_DUTYCYCLE_2;
    hi2c1.Init.OwnAddress1     = 0;
    hi2c1.Init.AddressingMode  = I2C_ADDRESSINGMODE_7BIT;
    hi2c1.Init.DualAddressMode = I2C_DUALADDRESS_DISABLE;
    hi2c1.Init.OwnAddress2     = 0;
    hi2c1.Init.GeneralCallMode = I2C_GENERALCALL_DISABLE;
    hi2c1.Init.NoStretchMode   = I2C_NOSTRETCH_DISABLE;
    HAL_I2C_Init(&hi2c1);
}

void HAL_I2C_MspInit(I2C_HandleTypeDef* i2cHandle)
{
    if (i2cHandle->Instance == I2C1)
    {
        __HAL_RCC_GPIOB_CLK_ENABLE();
        __HAL_RCC_I2C1_CLK_ENABLE();

        GPIO_InitTypeDef GPIO_InitStruct = {0};
        GPIO_InitStruct.Pin       = I2C1_SCL_PIN | I2C1_SDA_PIN;
        GPIO_InitStruct.Mode      = GPIO_MODE_AF_OD;
        GPIO_InitStruct.Pull      = GPIO_NOPULL;   // 외부 풀업(PCF8574 보드 내장) 가정
        GPIO_InitStruct.Speed     = GPIO_SPEED_FREQ_HIGH;
        GPIO_InitStruct.Alternate = I2C1_AF;
        HAL_GPIO_Init(I2C1_SCL_PORT, &GPIO_InitStruct);

        /* 필요시 I2C IRQ 설정 가능 (일반 폴링/블로킹이면 생략) */
    }
}

void HAL_I2C_MspDeInit(I2C_HandleTypeDef* i2cHandle)
{
    if (i2cHandle->Instance == I2C1)
    {
        __HAL_RCC_I2C1_CLK_DISABLE();
        HAL_GPIO_DeInit(I2C1_SCL_PORT, I2C1_SCL_PIN | I2C1_SDA_PIN);
    }
}
